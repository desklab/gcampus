{% extends "gcampuscore/base.html" %}
{% load i18n map l10n tz %}
{% block extra_head %}
    {{ block.super }}
    {% load_mapbox_css %}
{% endblock %}
{% block body_class %}d-flex flex-column min-vh-100{% endblock %}
{% block main_class %}main-pt-0 px-0{% endblock %}
{% block navbar_title %}<span>{{ object }}</span>{% endblock %}
{% if can_edit %}
    {% block modals %}
        {{ block.super }}
        {% include "gcampuscore/components/report_modal.html" %}
        <div class="modal fade"
             id="deleteModal"
             tabindex="-1"
             aria-labelledby="deleteModal"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModal">
                            {% translate "Delete Measurement" %}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="{% translate "Close" %}"></button>
                    </div>
                    <div class="modal-body">
                        <form method="POST" action="{% url "gcampuscore:delete-measurement" pk=object.pk %}">
                            {% csrf_token %}
                            {% blocktranslate trimmed %}
                                Are you sure you want to delete this measurement?
                            {% endblocktranslate %}
                            <ul>
                                <li>
                                    <b>{% translate "Name" %}:</b>
                                    {{ object.name }}
                                </li>
                                <li>
                                    <b>{% translate "Time" context "measurement time" %}:</b>
                                    {{ object.time|localtime|localtime|localize }}
                                </li>
                                <li>
                                    <b>{% translate "Water name" %}:</b>
                                    {% if object.water_name %}
                                        {{ object.water_name }}
                                    {% else %}
                                        {% translate "N/A" context "no value provided (water name, comment, etc)" %}
                                    {% endif %}
                                </li>
                            </ul>
                            <div class="modal-footer">
                                <button type="button" class="btn" data-bs-dismiss="modal">
                                    {% translate "Close" %}
                                </button>
                                <button type="submit" class="btn btn-danger">
                                    {% translate "Delete" %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% endblock %}
{% endif %}
{% block content %}
    <div class="container-fluid px-0">
        <div class="bg-light" id="measurement-head">
            <div class="container py-4">
                <div class="row">
                    <div class="col-12 col-md-6 d-flex flex-column">
                        <div class="d-flex flex-row justify-content-between mb-3">
                            <div>
                                <small class="text-muted">{% translate "Water name" %}</small>
                                <br>
                                <h4>
                                    {% if object.water_name %}
                                        <a class="text-reset text-decoration-none hover-secondary"
                                           href="{% url "gcampuscore:water-detail" pk=object.water.pk %}">
                                            {{ object.water_name }}
                                        </a>
                                    {% else %}
                                        {% translate "N/A" context "no value provided (water name, comment, etc)" %}
                                    {% endif %}
                                </h4>
                            </div>
                            <div>
                                <small class="text-muted">{% translate "Time" context "measurement time" %}</small>
                                <br>
                                <h4>{{ object.time|localtime|localtime|localize }}</h4>
                            </div>
                            {# Add additional div for placing #}
                            <div></div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">{% translate "Note" %}</small>
                            <br>
                            <p>
                                {% if object.comment %}
                                    {{ object.comment }}
                                {% else %}
                                    {% translate "N/A" context "no value provided (water name, comment, etc)" %}
                                {% endif %}
                            </p>
                        </div>
                        <div class="mt-auto">
                            <a class="btn btn-sm btn-secondary"
                               href="{% url "gcampuscore:mapview" %}{% map_options_url lng=measurement.location.x|unlocalize lat=measurement.location.y|unlocalize zoom=14 %}"
                               role="link">
                                {% translate "Explore environment" %}
                            </a>
                            {% if can_edit %}
                                <a href="{% url "gcampuscore:edit-measurement" pk=measurement.pk %}"
                                   class="btn btn-sm btn-secondary"
                                   role="button">
                                    {% translate "Edit" %}
                                </a>
                                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal"
                                        data-bs-target="#deleteModal">
                                    {% translate "Delete" %}
                                </button>
                            {% endif %}
                            <button class="btn btn-sm btn btn btn-outline-secondary" type="button"
                                    data-bs-toggle="modal"
                                    data-bs-target="#reportModal">
                                {% translate "Report measurement" %}
                            </button>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <style>
                            #map-detail {
                                width: 100%;
                                height: 320px;
                            }
                        </style>
                        {% map onload="loadCluster" zoom=14 container="map-detail" class="shadow-sm" center=measurement.location.tuple %}
                    </div>
                </div>
            </div>
        </div>
        <div class="py-4" id="measurement-body measurement-data">
            <div class="container">
                <h3 class="mb-4 fw-light">{% translate "Measured values" %}</h3>
                <table class="table table-hover">
                    <thead>
                    <tr>
                        <th scope="col">{% translate "Parameter" %}</th>
                        <th scope="col">{% translate "Value" %}</th>
                        <th scope="col">{% translate "Note" %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for parameter in object.parameters.all %}
                        <tr> {# TODO: fix td width when expanding note, fix postion of button for expanding/collapsing #}
                            <td>{{ parameter.parameter_type.name }}</td>
                            <td class="font-monospace">
                                {{ parameter.value }}&nbsp;{{ parameter.parameter_type.unit }}
                            </td>
                            <td>
                                {% if parameter.comment %}
                                    <div>
                                        <a class="text-decoration-none text-dark hover-secondary"
                                           data-bs-toggle="collapse"
                                           href="#CommentCollapse{{ forloop.counter }}"
                                           role="button"
                                           onclick="setCookie()"
                                           id="CommentCollapseButton{{ forloop.counter }}"
                                           aria-controls="CommentCollapse{{ forloop.counter }}">
                                            {% translate "Expand note" %}
                                        </a> {# TODO: change text to "hide note" when expanded #}
                                    </div>
                                    <div class="collapse"
                                         id="CommentCollapse{{ forloop.counter }}">
                                        <div class="card card-body">
                                            <small>{{ parameter.comment }}</small>
                                        </div>
                                    </div>
                                {% else %}
                                    {% translate "N/A" context "no value provided (water name, comment, etc)" %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="container py-4">
            <h3 class="mt-3 fw-light">{% trans "Documents" %}</h3>
            <div class="mt-4 list-group list-group-spaced">
            {% url "gcampusdocuments:measurement-detail" pk=measurement.pk as url%}
            {% translate "Save detail view" as title %}
            {% blocktrans asvar body trimmed %}
                Download a PDF with the detailed information of this measurement.
                This document is intended to provide you with all the information of this measurement in a well printable layout.
            {% endblocktrans %}
            {% include "gcampusauth/components/document_download_card.html" with icon="gcampuscore/icons/cloud-download.html" %}

            {% url "gcampusdocuments:measurement-assessment" pk=measurement.pk as url %}
            {% translate "Save template for assessment (M08)" as title %}
            {% blocktrans asvar body trimmed %}
                Download a PDF with a template to assess the ecological quality based on this measurement.
                This document is referenced as M08 in the teaching materials.
            {% endblocktrans %}
            {% include "gcampusauth/components/document_download_card.html" with icon="gcampuscore/icons/cloud-download.html" %}
        </div>
        </div>
    </div>
{% endblock %}
{% block extra_body %}
    <script type="text/html" id="measurementPopupTemplate">
        {% include "gcampuscore/components/map_popup.html" %}
    </script>
    <script>
        function loadCluster(event) {
            let map = event.target;
            let lng = {{ measurement.location.x|unlocalize }};
            let lat = {{ measurement.location.y|unlocalize }};
            const el = document.createElement('span');
            el.className = 'marker';
            const marker = new gcampusmap['mapbox-gl'].mapboxgl.Marker(el)
                .setLngLat([lng, lat])
                .addTo(map);
            gcampusmap['mapbox-gl'].setupCluster(
                '{% url "gcampusapi:measurement-list" %}', map
            );
        }
    </script>
    {% load_mapbox_js %}
{% endblock %}
